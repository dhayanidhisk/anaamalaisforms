<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Registration Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #f472b6;
            --accent: #10b981;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
        }

        body {
            background-color: #0f172a;
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(244, 114, 182, 0.15) 0px, transparent 50%);
            font-family: 'Outfit', sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            color: #1e293b;
            padding: 20px 0;
        }

        .app-shell {
            width: 100%;
            max-width: 440px;
            height: 90vh;
            /* Fixed height for mobile feel */
            max-height: 850px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border-radius: 2rem;
            margin: auto;
            /* Center vertically and horizontally */
            border: 1px solid rgba(255, 255, 255, 0.4);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Premium Header */
        .app-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.25rem 1.75rem;
            flex-shrink: 0;
            /* Don't shrink header */
            z-index: 50;
            border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-container {
            padding: 1.75rem 1.75rem 4rem 1.75rem;
            flex-grow: 1;
            overflow-y: auto;
            /* Enable internal scrolling */
            scrollbar-width: none;
            /* Hide scrollbar for clean look */
            -ms-overflow-style: none;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .form-container::-webkit-scrollbar {
            display: none;
            /* Hide scrollbar Chrome/Safari */
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            display: flex;
            align-items: center;
            font-size: 1.15rem;
            font-weight: 700;
            color: #0f172a;
            margin: 1.5rem 0 1.25rem 0;
            letter-spacing: -0.01em;
            padding-left: 0.5rem;
            border-left: 4px solid var(--primary);
        }

        .section-title i {
            margin-right: 0.75rem;
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* Beautiful Cards - Enhanced */
        .vehicle-card,
        .health-ins-card,
        .life-ins-card,
        .admin-card {
            background: #ffffff;
            border: 1px solid #f1f5f9;
            padding: 1.5rem;
            border-radius: 1.25rem;
            margin-bottom: 1.5rem;
            position: relative;
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .vehicle-card:hover,
        .health-ins-card:hover,
        .life-ins-card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            border-color: #e2e8f0;
        }

        .remove-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #ef4444;
            background: #fef2f2;
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }

        .remove-btn:hover {
            transform: scale(1.1) rotate(90deg);
            background: #ef4444;
            color: white;
        }

        /* Futuristic Input Groups */
        .input-group {
            position: relative;
            margin-bottom: 1.25rem;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            font-size: 0.95rem;
            font-family: inherit;
            color: #0f172a;
            transition: all 0.3s ease;
            appearance: none;
            font-weight: 500;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            background: #ffffff;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .input-group label {
            position: absolute;
            left: 3rem;
            top: 1rem;
            font-size: 0.95rem;
            color: #64748b;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            transform-origin: left top;
            z-index: 10;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 3.5rem);
        }

        .input-group input:focus+label,
        .input-group input:not(:placeholder-shown)+label,
        .input-group select:focus+label,
        .input-group select:valid+label {
            transform: translateY(-1.8rem) scale(0.7);
            /* Even higher and smaller */
            color: var(--primary);
            font-weight: 800;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: #ffffff;
            padding: 0 0.5rem;
            margin-left: -0.25rem;
            max-width: none;
        }

        .input-group input:focus+label::after,
        .input-group input:not(:placeholder-shown)+label::after {
            content: '';
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 1.15rem;
            color: #94a3b8;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .input-group:focus-within .input-icon {
            color: var(--primary);
            transform: scale(1.1);
        }

        /* Premium Buttons */
        .btn-submit {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.15rem;
            border-radius: 1.25rem;
            font-weight: 700;
            width: 100%;
            font-size: 1.05rem;
            border: none;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
            margin-top: 1rem;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.5);
            filter: brightness(1.1);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .btn-add {
            background: rgba(99, 102, 241, 0.05);
            color: var(--primary);
            border: 2px dashed rgba(99, 102, 241, 0.2);
            padding: 1rem;
            border-radius: 1.25rem;
            width: 100%;
            font-weight: 700;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .btn-add:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }

        .status-msg {
            display: none;
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
            padding: 1.25rem;
            border-radius: 1.25rem;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .hidden-view {
            display: none !important;
        }

        /* Modal Overhaul */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 1.5rem;
            padding: 2.25rem;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid #f1f5f9;
        }

        .modal-btn {
            width: 100%;
            padding: 1rem;
            border-radius: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            margin-top: 0.5rem;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .hidden-view {
            display: none !important;
        }

        /* Typography Scale */
        h1 {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        p.subtitle {
            color: #6b7280;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Mobile helpers */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-card {
            min-width: 120px;
            background: white;
            padding: 1rem;
        }

        /* Admin Login Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #111827;
        }

        .modal-btn {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }

        .stat-card {
            min-width: 120px;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>

<body>

    <div class="app-shell">
        <!-- New App Header -->
        <header class="app-header">
            <div class="flex items-center">
                <img id="companyLogo"
                    src="https://lh4.googleusercontent.com/proxy/LhTn6mvLVkWS0D-QtEgbclZD431kKxD-dcaAMl3AHFMJyXB8s38Fwjm5QHrmVEc0uYRCJBL9eg9hDhItRelxz3K8vkeUfALYQ-rC"
                    alt="Company Logo" class="h-12 object-contain cursor-pointer">
            </div>
            <div id="editIconBtn"
                class="text-xs text-gray-400 font-medium cursor-pointer hover:text-blue-500 transition-colors flex items-center">
                <i class="fas fa-edit mr-1"></i> Edit Form
            </div>
        </header>

        <div class="form-container">
            <!-- USER VIEW -->
            <div id="userView">
                <div class="text-center mb-10">
                    <h1 class="text-3xl font-bold text-gray-900">Anaamalais Assurance</h1>
                    <p class="text-gray-500 mt-2">Update your insurance details for company records.</p>
                </div>

                <div id="statusMessage" class="status-msg"></div>

                <form id="employeeVehicleForm">
                    <div class="admin-card">
                        <div class="section-title !mt-0 !mb-6 !pl-0 !border-l-0">
                            <i class="fas fa-id-card"></i> Employee Details
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="input-group">
                                <i class="fas fa-code-branch input-icon"></i>
                                <select id="branch" name="branch" required>
                                    <option value="" disabled selected></option>
                                    <option value="Tiruppur">Tiruppur</option>
                                    <option value="Coimbatore">Coimbatore</option>
                                    <option value="Erode">Erode</option>
                                    <option value="Gopi">Gopi</option>
                                    <option value="Kumbakonam">Kumbakonam</option>
                                    <option value="Nilgiris">Nilgiris</option>
                                    <option value="Pollachi">Pollachi</option>
                                    <option value="Salem">Salem</option>
                                    <option value="Trichy">Trichy</option>
                                    <option value="Thanjavur">Thanjavur</option>
                                    <option value="Mettupalayam">Mettupalayam</option>
                                    <option value="Madhampatti">Madhampatti</option>
                                    <option value="Bhavani">Bhavani</option>
                                    <option value="Dharapuram">Dharapuram</option>
                                    <option value="Udumalpet">Udumalpet</option>
                                    <option value="Kangeyam">Kangeyam</option>
                                    <option value="Dharmapuri">Dharmapuri</option>
                                    <option value="Ariyalur">Ariyalur</option>
                                    <option value="Perambalur">Perambalur</option>
                                    <option value="Pattukottai">Pattukottai</option>
                                    <option value="Karur">Karur</option>
                                    <option value="Other">Other Option</option>
                                </select>
                                <label for="branch">Branch</label>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="fullName" name="fullName" placeholder=" " required>
                                <label for="fullName">Full Name</label>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-mobile-alt input-icon"></i>
                                <input type="tel" id="mobile" name="mobile" placeholder=" " required
                                    pattern="[0-9]{10}">
                                <label for="mobile">Mobile Number</label>
                            </div>
                            <div class="input-group">
                                <i class="fas fa-building input-icon"></i>
                                <select id="department" name="department" required>
                                    <option value="" disabled selected></option>
                                    <option value="Sales">Sales</option>
                                    <option value="Service">Service</option>
                                    <option value="U Trust">U Trust</option>
                                    <option value="Spares">Spares</option>
                                    <option value="HR">HR</option>
                                    <option value="CR">CR</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Accounts">Accounts</option>
                                    <option value="DCAC">DCAC</option>
                                    <option value="EDP">EDP</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Civil">Civil</option>
                                    <option value="Finance">Finance</option>
                                    <option value="House Keeping">House Keeping</option>
                                    <option value="Insurance">Insurance</option>
                                    <option value="Other">Other Option</option>
                                </select>
                                <label for="department">Department</label>
                            </div>
                            <div class="input-group md:col-span-2">
                                <i class="fas fa-id-badge input-icon"></i>
                                <input type="text" id="designation" name="designation" placeholder=" " required>
                                <label for="designation">Designation</label>
                            </div>
                        </div>
                    </div>

                    <!-- Health Insurance Section -->
                    <div class="section-title mt-8">
                        <i class="fas fa-heartbeat"></i> Health Insurance Details
                    </div>
                    <div id="healthInsContainer"></div>
                    <button type="button" id="addHealthInsBtn" class="btn-add">
                        <i class="fas fa-plus-circle mr-2"></i> Add Another Health Insurance
                    </button>

                    <!-- Life Insurance Section -->
                    <div class="section-title mt-8">
                        <i class="fas fa-shield-alt"></i> Life Insurance Details
                    </div>
                    <div id="lifeInsContainer"></div>
                    <button type="button" id="addLifeInsBtn" class="btn-add">
                        <i class="fas fa-plus-circle mr-2"></i> Add Another Life Insurance
                    </button>

                    <div class="mt-8 mb-4">
                        <div class="section-title">
                            <i class="fas fa-car-side"></i> Motor Insurance Details
                        </div>
                    </div>

                    <div id="vehiclesContainer"></div>

                    <button type="button" id="addVehicleBtn" class="btn-add">
                        <i class="fas fa-plus-circle mr-2"></i> Add Another Vehicle
                    </button>

                    <button type="submit" id="submitBtn" class="btn-submit">Submit Registration</button>
                </form>
            </div>

            <!-- Admin Login Modal -->
            <div id="adminLoginModal" class="modal-overlay hidden-view">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="m-0">Admin Login</h3>
                        <button type="button" id="closeLoginModal"
                            class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="loginError" class="hidden-view text-red-600 text-sm mb-4 bg-red-50 p-3 rounded-lg"></div>
                    <form id="adminLoginForm">
                        <div class="input-group">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="adminUsername" placeholder=" " required>
                            <label>Username</label>
                        </div>
                        <div class="input-group">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="adminPassword" placeholder=" " required>
                            <label>Password</label>
                        </div>
                        <button type="submit" class="modal-btn modal-btn-primary">
                            <i class="fas fa-sign-in-alt mr-2"></i> Login
                        </button>
                    </form>
                </div>
            </div>

            <!-- User Edit Login Modal -->
            <div id="userEditModal" class="modal-overlay hidden-view">
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900 m-0">Edit Your Form</h3>
                        <button type="button" id="closeUserEditModal"
                            class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mb-6">Enter your registered mobile number to retrieve and edit your
                        details.</p>
                    <div id="userEditError" class="hidden-view text-red-600 text-sm mb-4 bg-red-50 p-3 rounded-lg">
                    </div>
                    <form id="userEditForm">
                        <div class="input-group">
                            <i class="fas fa-mobile-alt input-icon"></i>
                            <input type="tel" id="editMobileLookup" placeholder=" " required pattern="[0-9]{10}">
                            <label>Mobile Number</label>
                        </div>
                        <button type="submit" id="lookupBtn" class="modal-btn modal-btn-primary">
                            <i class="fas fa-search mr-2"></i> Find My Details
                        </button>
                    </form>
                </div>
            </div>

            <!-- ADMIN VIEW -->
            <div id="adminView" class="hidden-view">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center">
                        <button id="adminBackBtn" class="mr-4 text-gray-400 hover:text-gray-600">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Submissions</h2>
                            <p class="text-xs text-gray-500">Employee records</p>
                        </div>
                    </div>
                    <button id="downloadExcelBtn"
                        class="bg-green-100 text-green-700 px-3 py-2 rounded-lg text-xs font-bold flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> Export
                    </button>
                </div>

                <!-- Stats or Filters could go here -->

                <div id="submissionsList">
                    <!-- Data cards added by JS -->
                    <div id="emptyTableMsg" class="text-center py-10 text-gray-400">Loading records...</div>
                </div>
            </div>

            <!-- Copyright Footer -->
            <div class="text-center py-6 text-xs text-gray-400 border-t border-gray-100 mt-8">
                Copyright 2026 All rights reserved @ Anaamalais Digital Service
            </div>
        </div>

    </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, query, getDocs, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global environment variables
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        const firebaseConfig = envConfig || {
            apiKey: "AIzaSyDvR3exUqGJYlwqMnAqlTiNW7vyKjrjaiQ",
            authDomain: "forms-cd472.firebaseapp.com",
            projectId: "forms-cd472",
            storageBucket: "forms-cd472.firebasestorage.app",
            messagingSenderId: "782383484064",
            appId: "1:782383484064:web:d104bed0f5ea1139fe8dc5",
            measurementId: "G-VMWJHK6X0T"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'forms-cd472-default';

        // DOM Elements
        const form = document.getElementById('employeeVehicleForm');
        const container = document.getElementById('vehiclesContainer');
        const healthContainer = document.getElementById('healthInsContainer');
        const lifeContainer = document.getElementById('lifeInsContainer');
        const addBtn = document.getElementById('addVehicleBtn');
        const addHealthBtn = document.getElementById('addHealthInsBtn');
        const addLifeBtn = document.getElementById('addLifeInsBtn');
        const statusMsg = document.getElementById('statusMessage');
        const userView = document.getElementById('userView');
        const adminView = document.getElementById('adminView');
        const adminBackBtn = document.getElementById('adminBackBtn');
        const listContainer = document.getElementById('submissionsList');
        const emptyMsg = document.getElementById('emptyTableMsg');
        const downloadBtn = document.getElementById('downloadExcelBtn');
        const editIconBtn = document.getElementById('editIconBtn');
        const userEditModal = document.getElementById('userEditModal');
        const userEditForm = document.getElementById('userEditForm');
        const userEditError = document.getElementById('userEditError');
        const closeUserEditModal = document.getElementById('closeUserEditModal');

        let vehicleCount = 0;
        let healthInsCount = 0;
        let lifeInsCount = 0;
        let currentUser = null;
        let allSubmissions = [];
        let isAdminLoggedIn = false;
        let currentEditingId = null; // Track if we are editing an existing document

        // Auth Logic
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth initialization failed", error);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("Database connected successfully! User ID:", user.uid);
                listenToSubmissions();
            } else {
                console.log("Waiting for database connection...");
            }
        });

        // Admin Login Elements
        const adminLoginModal = document.getElementById('adminLoginModal');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const loginError = document.getElementById('loginError');

        const companyLogo = document.getElementById('companyLogo');

        // Navigation
        adminBackBtn.onclick = () => {
            userView.classList.remove('hidden-view');
            adminView.classList.add('hidden-view');
        };

        // Hidden Admin Access via double click on logo
        companyLogo.ondblclick = () => {
            if (!isAdminLoggedIn) {
                adminLoginModal.classList.remove('hidden-view');
            } else {
                showAdminView();
            }
        };

        // Edit Form Access
        editIconBtn.onclick = () => {
            userEditModal.classList.remove('hidden-view');
        };

        if (closeUserEditModal) {
            closeUserEditModal.onclick = () => {
                userEditModal.classList.add('hidden-view');
                userEditForm.reset();
                userEditError.classList.add('hidden-view');
            };
        }

        userEditModal.onclick = (e) => {
            if (e.target === userEditModal) {
                userEditModal.classList.add('hidden-view');
                userEditForm.reset();
                userEditError.classList.add('hidden-view');
            }
        };

        // User Edit Lookup Logic
        userEditForm.onsubmit = async (e) => {
            e.preventDefault();
            const mobile = document.getElementById('editMobileLookup').value;
            const lookupBtn = document.getElementById('lookupBtn');

            userEditError.classList.add('hidden-view');
            lookupBtn.disabled = true;
            lookupBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Searching...';

            try {
                const q = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'submissions'),
                    where('mobile', '==', mobile)
                );
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    currentEditingId = doc.id;
                    populateForm(doc.data());
                    userEditModal.classList.add('hidden-view');
                    userEditForm.reset();
                    alert("Success! Your details have been loaded for editing. Please update and submit.");
                } else {
                    userEditError.textContent = "No record found with this mobile number. Please register first.";
                    userEditError.classList.remove('hidden-view');
                }
            } catch (err) {
                console.error("Lookup error:", err);
                userEditError.textContent = "Error: " + err.message;
                userEditError.classList.remove('hidden-view');
            } finally {
                lookupBtn.disabled = false;
                lookupBtn.innerHTML = '<i class="fas fa-search mr-2"></i> Find My Details';
            }
        };

        function populateForm(data) {
            // Reset form first
            form.reset();
            container.innerHTML = '';
            healthContainer.innerHTML = '';
            lifeContainer.innerHTML = '';
            vehicleCount = 0;
            healthInsCount = 0;
            lifeInsCount = 0;

            // Basic Info
            document.getElementById('branch').value = data.branch || '';
            document.getElementById('fullName').value = data.fullName || '';
            document.getElementById('mobile').value = data.mobile || '';
            document.getElementById('department').value = data.department || '';
            document.getElementById('designation').value = data.designation || '';

            // Health Insurance
            if (Array.isArray(data.healthIns) && data.healthIns.length > 0) {
                data.healthIns.forEach(h => {
                    createHealthInsSection();
                    const card = healthContainer.lastElementChild;
                    card.querySelector('[name="relationship"]').value = h.relationship || '';
                    card.querySelector('[name="healthInsAvail"]').value = h.available || '';

                    // Trigger toggle to setup fields
                    toggleHealthIns(card.querySelector('[name="healthInsAvail"]'));
                    toggleCardRelationship(card.querySelector('[name="relationship"]'));

                    if (h.available === 'Yes') {
                        const providerSelect = card.querySelector('[name="healthInsProvider"]');
                        const options = Array.from(providerSelect.options).map(o => o.value);
                        if (options.includes(h.provider)) {
                            providerSelect.value = h.provider;
                        } else {
                            providerSelect.value = 'Other';
                            toggleHealthInsOther(providerSelect);
                            card.querySelector('[name="healthInsOther"]').value = h.provider;
                        }
                        card.querySelector('[name="healthInsID"]').value = h.id || '';
                        card.querySelector('[name="healthInsExpiry"]').value = h.expiry || '';
                    }
                    if (h.beneficiary) {
                        card.querySelector('[name="referralDetail"]').value = h.beneficiary;
                    }
                });
            } else {
                createHealthInsSection();
            }

            // Life Insurance
            if (Array.isArray(data.lifeIns) && data.lifeIns.length > 0) {
                data.lifeIns.forEach(l => {
                    createLifeInsSection();
                    const card = lifeContainer.lastElementChild;
                    card.querySelector('[name="relationship"]').value = l.relationship || '';
                    card.querySelector('[name="lifeInsAvail"]').value = l.available || '';

                    toggleLifeIns(card.querySelector('[name="lifeInsAvail"]'));
                    toggleCardRelationship(card.querySelector('[name="relationship"]'));

                    if (l.available === 'Yes') {
                        const providerSelect = card.querySelector('[name="lifeInsProvider"]');
                        const options = Array.from(providerSelect.options).map(o => o.value);
                        if (options.includes(l.provider)) {
                            providerSelect.value = l.provider;
                        } else {
                            providerSelect.value = 'Other';
                            toggleLifeInsOther(providerSelect);
                            card.querySelector('[name="lifeInsOther"]').value = l.provider;
                        }
                        card.querySelector('[name="lifeInsID"]').value = l.id || '';
                        card.querySelector('[name="lifeInsExpiry"]').value = l.expiry || '';
                    }
                    if (l.beneficiary) {
                        card.querySelector('[name="referralDetail"]').value = l.beneficiary;
                    }
                });
            } else {
                createLifeInsSection();
            }

            // Vehicles
            if (Array.isArray(data.vehicles) && data.vehicles.length > 0) {
                data.vehicles.forEach(v => {
                    createVehicleSection();
                    const card = container.lastElementChild;
                    for (const key in v) {
                        const input = card.querySelector(`[name="${key}"]`);
                        if (input) {
                            input.value = v[key];
                            if (key === 'ins_avail') toggleVehicleInsurance(input);
                            if (key === 'relationship') toggleCardRelationship(input);
                        }
                    }
                });
            } else {
                createVehicleSection();
            }

            // Update submit button text
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-2"></i> Update My Details';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Close modal button
        const closeLoginModal = document.getElementById('closeLoginModal');
        if (closeLoginModal) {
            closeLoginModal.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Close button clicked');
                adminLoginModal.classList.add('hidden-view');
                adminLoginForm.reset();
                loginError.classList.add('hidden-view');
            };
        }

        // Prevent modal content clicks from closing the modal
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
            modalContent.onclick = (e) => {
                e.stopPropagation();
            };
        }

        // Close modal when clicking outside
        adminLoginModal.onclick = (e) => {
            if (e.target === adminLoginModal) {
                console.log('Clicked outside modal');
                adminLoginModal.classList.add('hidden-view');
                adminLoginForm.reset();
                loginError.classList.add('hidden-view');
            }
        };

        // Admin Login Logic
        adminLoginForm.onsubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            console.log('Login attempt:', username);
            loginError.classList.add('hidden-view');

            try {
                // Query Firestore for admin credentials
                const adminQuery = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'admin_credentials'),
                    where('username', '==', username),
                    where('password', '==', password)
                );

                console.log('Querying credentials...');
                const snapshot = await getDocs(adminQuery);
                console.log('Query result, empty?', snapshot.empty, 'Size:', snapshot.size);

                if (!snapshot.empty) {
                    console.log('Login successful!');
                    isAdminLoggedIn = true;
                    adminLoginModal.classList.add('hidden-view');
                    showAdminView();
                    adminLoginForm.reset();
                } else {
                    console.log('No matching credentials found');
                    loginError.textContent = 'Invalid username or password';
                    loginError.classList.remove('hidden-view');
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = 'Login failed: ' + error.message;
                loginError.classList.remove('hidden-view');
            }
        };

        function showAdminView() {
            adminView.classList.remove('hidden-view');
            userView.classList.add('hidden-view');
        }

        // UI Helpers
        // UI Helpers
        window.toggleCardRelationship = (select) => {
            const card = select.closest('.health-ins-card, .life-ins-card, .vehicle-card');
            const nameGroup = card.querySelector('.referralDetailGroup');
            const nameInput = card.querySelector('[name="referralDetail"]');
            const mobileGroup = card.querySelector('.referralMobileGroup');
            const mobileInput = card.querySelector('[name="referralMobile"]');

            // Show for everything EXCEPT 'Self'
            const isSelf = select.value === 'Self' || select.value === '';

            if (!isSelf) {
                nameGroup.classList.remove('hidden-view');
                nameInput.required = true;
                mobileGroup.classList.remove('hidden-view');
                mobileInput.required = true;
            } else {
                nameGroup.classList.add('hidden-view');
                nameInput.value = '';
                nameInput.required = false;
                mobileGroup.classList.add('hidden-view');
                mobileInput.value = '';
                mobileInput.required = false;
            }
        };

        window.toggleHealthIns = (select) => {
            const card = select.closest('.health-ins-card');
            const provider = card.querySelector('[name="healthInsProvider"]');
            const otherGroup = card.querySelector('.healthInsOtherGroup');
            const otherInput = card.querySelector('[name="healthInsOther"]');
            const idInput = card.querySelector('[name="healthInsID"]');
            const expiryInput = card.querySelector('[name="healthInsExpiry"]');

            const isNo = select.value === 'No';

            if (isNo) {
                provider.value = '';
                provider.disabled = true;
                provider.classList.add('bg-gray-100');

                // Hide other if visible
                otherGroup.classList.add('hidden-view');
                otherInput.value = '';
                otherInput.required = false;

                idInput.value = 'N/A';
                idInput.classList.add('bg-gray-100');
                idInput.disabled = true;
                expiryInput.value = '';
                expiryInput.disabled = true;
                expiryInput.classList.add('bg-gray-100');
            } else {
                provider.disabled = false;
                provider.classList.remove('bg-gray-100');

                idInput.value = '';
                idInput.classList.remove('bg-gray-100');
                idInput.disabled = false;
                expiryInput.disabled = false;
                expiryInput.classList.remove('bg-gray-100');
            }
        };

        window.toggleHealthInsOther = (select) => {
            const card = select.closest('.health-ins-card');
            const otherGroup = card.querySelector('.healthInsOtherGroup');
            const otherInput = card.querySelector('[name="healthInsOther"]');
            if (select.value === 'Other') {
                otherGroup.classList.remove('hidden-view');
                otherInput.required = true;
            } else {
                otherGroup.classList.add('hidden-view');
                otherInput.value = '';
                otherInput.required = false;
            }
        };

        window.toggleLifeIns = (select) => {
            const card = select.closest('.life-ins-card');
            const provider = card.querySelector('[name="lifeInsProvider"]');
            const otherGroup = card.querySelector('.lifeInsOtherGroup');
            const otherInput = card.querySelector('[name="lifeInsOther"]');
            const idInput = card.querySelector('[name="lifeInsID"]');
            const expiryInput = card.querySelector('[name="lifeInsExpiry"]');

            const isNo = select.value === 'No';

            if (isNo) {
                provider.value = '';
                provider.disabled = true;
                provider.classList.add('bg-gray-100');

                // Hide other if visible
                otherGroup.classList.add('hidden-view');
                otherInput.value = '';
                otherInput.required = false;

                idInput.value = 'N/A';
                idInput.classList.add('bg-gray-100');
                idInput.disabled = true;
                expiryInput.value = '';
                expiryInput.disabled = true;
                expiryInput.classList.add('bg-gray-100');
            } else {
                provider.disabled = false;
                provider.classList.remove('bg-gray-100');

                idInput.value = '';
                idInput.classList.remove('bg-gray-100');
                idInput.disabled = false;
                expiryInput.disabled = false;
                expiryInput.classList.remove('bg-gray-100');
            }
        };

        window.toggleLifeInsOther = (select) => {
            const card = select.closest('.life-ins-card');
            const otherGroup = card.querySelector('.lifeInsOtherGroup');
            const otherInput = card.querySelector('[name="lifeInsOther"]');
            if (select.value === 'Other') {
                otherGroup.classList.remove('hidden-view');
                otherInput.required = true;
            } else {
                otherGroup.classList.add('hidden-view');
                otherInput.value = '';
                otherInput.required = false;
            }
        };



        window.toggleVehicleInsurance = (select) => {
            const card = select.closest('.vehicle-card');
            const numInput = card.querySelector('[name="ins_num"]');
            const dateInput = card.querySelector('[name="ins_expiry"]');
            const isNo = select.value === 'No';
            if (isNo) {
                numInput.value = 'N/A';
                numInput.disabled = true;
                numInput.classList.add('bg-gray-100');
                dateInput.value = '';
                dateInput.disabled = true;
                dateInput.classList.add('bg-gray-100');
            } else {
                numInput.value = '';
                numInput.disabled = false;
                numInput.classList.remove('bg-gray-100');
                dateInput.disabled = false;
                dateInput.classList.remove('bg-gray-100');
            }
        };

        function createHealthInsSection() {
            healthInsCount++;
            const section = document.createElement('div');
            section.className = 'health-ins-card';
            section.id = `h-sec-${healthInsCount}`;
            section.innerHTML = `
                ${healthInsCount > 1 ? `<span class="remove-btn" onclick="document.getElementById('h-sec-${healthInsCount}').remove()"><i class="fas fa-trash"></i></span>` : ''}
                <div class="font-bold text-gray-800 mb-6 flex items-center text-lg">
                    <span class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm shadow-md">${healthInsCount}</span>
                    Health Insurance Details
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="input-group">
                        <i class="fas fa-user-friends input-icon"></i>
                        <select name="relationship" onchange="toggleCardRelationship(this)" required>
                            <option value="" disabled selected></option>
                            <option value="Self">Self</option>
                            <option value="Family">Family</option>
                            <option value="Friend">Friend</option>
                            <option value="Neighbor">Neighbor</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Relationship</label>
                    </div>
                    <div class="input-group hidden-view referralDetailGroup">
                        <i class="fas fa-pen input-icon"></i>
                        <input type="text" name="referralDetail" placeholder=" ">
                        <label>Beneficiary Name</label>
                    </div>
                    <div class="input-group hidden-view referralMobileGroup">
                        <i class="fas fa-mobile-alt input-icon"></i>
                        <input type="tel" name="referralMobile" placeholder=" " pattern="[0-9]{10}">
                        <label>Mobile Number</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-question-circle input-icon"></i>
                        <select name="healthInsAvail" onchange="toggleHealthIns(this)" required>
                            <option value="" disabled selected></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <label>Available?</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-hospital input-icon"></i>
                        <select name="healthInsProvider" onchange="toggleHealthInsOther(this)">
                            <option value="" disabled selected></option>
                            <option value="Star Health and Allied Insurance">Star Health and Allied Insurance</option>
                            <option value="Niva Bupa Health Insurance">Niva Bupa Health Insurance</option>
                            <option value="ManipalCigna Health Insurance">ManipalCigna Health Insurance</option>
                            <option value="Care Health Insurance">Care Health Insurance</option>
                            <option value="ICICI Lombard General Insurance">ICICI Lombard General Insurance</option>
                            <option value="Tata AIG General Insurance">Tata AIG General Insurance</option>
                            <option value="Aditya Birla Health Insurance">Aditya Birla Health Insurance</option>
                            <option value="Bajaj Allianz General Insurance">Bajaj Allianz General Insurance</option>
                            <option value="Future Generali India Insurance">Future Generali India Insurance</option>
                            <option value="Go Digit General Insurance">Go Digit General Insurance</option>
                            <option value="IFFCO Tokio General Insurance">IFFCO Tokio General Insurance</option>
                            <option value="Kotak Mahindra General Insurance">Kotak Mahindra General Insurance</option>
                            <option value="Liberty General Insurance">Liberty General Insurance</option>
                            <option value="Royal Sundaram General Insurance">Royal Sundaram General Insurance</option>
                            <option value="SBI General Insurance">SBI General Insurance</option>
                            <option value="Universal Sampo General Insurance">Universal Sampo General Insurance</option>
                            <option value="Zuno General Insurance">Zuno General Insurance</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Insurance Company</label>
                    </div>
                    <div class="input-group hidden-view healthInsOtherGroup">
                        <i class="fas fa-pen input-icon"></i>
                        <input type="text" name="healthInsOther" placeholder=" ">
                        <label>Specify Company Name</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-id-card input-icon"></i>
                        <input type="text" name="healthInsID" placeholder=" ">
                        <label>Policy/Card No</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-calendar-day input-icon"></i>
                        <input type="date" name="healthInsExpiry" placeholder=" ">
                        <label>Expired Date</label>
                    </div>
                </div>
            `;
            healthContainer.appendChild(section);
        }

        function createLifeInsSection() {
            lifeInsCount++;
            const section = document.createElement('div');
            section.className = 'life-ins-card';
            section.id = `l-sec-${lifeInsCount}`;
            section.innerHTML = `
                ${lifeInsCount > 1 ? `<span class="remove-btn" onclick="document.getElementById('l-sec-${lifeInsCount}').remove()"><i class="fas fa-trash"></i></span>` : ''}
                <div class="font-bold text-gray-800 mb-6 flex items-center text-lg">
                    <span class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm shadow-md">${lifeInsCount}</span>
                    Life Insurance Details
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="input-group">
                        <i class="fas fa-user-friends input-icon"></i>
                        <select name="relationship" onchange="toggleCardRelationship(this)" required>
                            <option value="" disabled selected></option>
                            <option value="Self">Self</option>
                            <option value="Family">Family</option>
                            <option value="Friend">Friend</option>
                            <option value="Neighbor">Neighbor</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Relationship</label>
                    </div>
                    <div class="input-group hidden-view referralDetailGroup">
                        <i class="fas fa-pen input-icon"></i>
                        <input type="text" name="referralDetail" placeholder=" ">
                        <label>Beneficiary Name</label>
                    </div>
                    <div class="input-group hidden-view referralMobileGroup">
                        <i class="fas fa-mobile-alt input-icon"></i>
                        <input type="tel" name="referralMobile" placeholder=" " pattern="[0-9]{10}">
                        <label>Mobile Number</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-question-circle input-icon"></i>
                        <select name="lifeInsAvail" onchange="toggleLifeIns(this)" required>
                            <option value="" disabled selected></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <label>Available?</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-umbrella input-icon"></i>
                        <select name="lifeInsProvider" onchange="toggleLifeInsOther(this)">
                            <option value="" disabled selected></option>
                            <option value="Life Insurance Corporation of India (LIC)">Life Insurance Corporation of India (LIC)</option>
                            <option value="HDFC Life Insurance Company">HDFC Life Insurance Company</option>
                            <option value="ICICI Prudential Life Insurance">ICICI Prudential Life Insurance</option>
                            <option value="SBI Life Insurance Company">SBI Life Insurance Company</option>
                            <option value="Bajaj Allianz Life Insurance">Bajaj Allianz Life Insurance</option>
                            <option value="Tata AIA Life Insurance">Tata AIA Life Insurance</option>
                            <option value="Max Life Insurance Company">Max Life Insurance Company</option>
                            <option value="Kotak Mahindra Life Insurance">Kotak Mahindra Life Insurance</option>
                            <option value="PNB MetLife India Insurance">PNB MetLife India Insurance</option>
                            <option value="Aditya Birla Sun Life Insurance">Aditya Birla Sun Life Insurance</option>
                            <option value="Axis Max Life Insurance">Axis Max Life Insurance</option>
                            <option value="Bandhan Life Insurance">Bandhan Life Insurance</option>
                            <option value="Bharti AXA Life Insurance">Bharti AXA Life Insurance</option>
                            <option value="Canara HSBC Life Insurance">Canara HSBC Life Insurance</option>
                            <option value="Edelweiss Life Insurance">Edelweiss Life Insurance</option>
                            <option value="Future Generali India Life Insurance">Future Generali India Life Insurance</option>
                            <option value="IndiaFirst Life Insurance">IndiaFirst Life Insurance</option>
                            <option value="Pramerica Life Insurance">Pramerica Life Insurance</option>
                            <option value="Shriram Life Insurance">Shriram Life Insurance</option>
                            <option value="Star Union Dai-ichi Life Insurance">Star Union Dai-ichi Life Insurance</option>
                            <option value="Aviva Life Insurance">Aviva Life Insurance</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Insurance Company</label>
                    </div>
                    <div class="input-group hidden-view lifeInsOtherGroup">
                        <i class="fas fa-pen input-icon"></i>
                        <input type="text" name="lifeInsOther" placeholder=" ">
                        <label>Specify Company Name</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-file-alt input-icon"></i>
                        <input type="text" name="lifeInsID" placeholder=" ">
                        <label>Policy Number</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-calendar-day input-icon"></i>
                        <input type="date" name="lifeInsExpiry" placeholder=" ">
                        <label>Expired Date</label>
                    </div>
                </div>
            `;
            lifeContainer.appendChild(section);
        }

        function createVehicleSection() {
            vehicleCount++;
            const section = document.createElement('div');
            section.className = 'vehicle-card';
            section.id = `v-sec-${vehicleCount}`;
            section.innerHTML = `
                ${vehicleCount > 1 ? `<span class="remove-btn" onclick="document.getElementById('v-sec-${vehicleCount}').remove()"><i class="fas fa-trash"></i></span>` : ''}
                <div class="font-bold text-gray-800 mb-6 flex items-center text-lg">
                    <span class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-full w-8 h-8 flex items-center justify-center mr-3 text-sm shadow-md">${vehicleCount}</span>
                    Vehicle Details
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="input-group">
                        <i class="fas fa-user-friends input-icon"></i>
                        <select name="relationship" onchange="toggleCardRelationship(this)" required>
                            <option value="" disabled selected></option>
                            <option value="Self">Self</option>
                            <option value="Family">Family</option>
                            <option value="Friend">Friend</option>
                            <option value="Neighbor">Neighbor</option>
                            <option value="Other">Other</option>
                        </select>
                        <label>Relationship</label>
                    </div>
                    <div class="input-group hidden-view referralDetailGroup">
                        <i class="fas fa-pen input-icon"></i>
                        <input type="text" name="referralDetail" placeholder=" ">
                        <label>Beneficiary Name</label>
                    </div>
                    <div class="input-group hidden-view referralMobileGroup">
                        <i class="fas fa-mobile-alt input-icon"></i>
                        <input type="tel" name="referralMobile" placeholder=" " pattern="[0-9]{10}">
                        <label>Mobile Number</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-motorcycle input-icon"></i>
                        <select name="type" required>
                            <option value="" disabled selected></option>
                            <option>Two-Wheeler</option>
                            <option>Four-Wheeler</option>
                        </select>
                        <label>Vehicle Type</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-tag input-icon"></i>
                        <input type="text" name="brand" placeholder=" " required>
                        <label>Brand</label>
                    </div>
                    <div class="input-group">
                         <i class="fas fa-car-side input-icon"></i>
                        <input type="text" name="model" placeholder=" " required>
                        <label>Model</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-user-tag input-icon"></i>
                        <select name="ownership" required>
                            <option value="" disabled selected></option>
                            <option>Single Owner</option>
                            <option>Second Handed Owner</option>
                        </select>
                        <label>Ownership Status</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-tachometer-alt input-icon"></i>
                        <input type="number" name="km" placeholder=" " required>
                        <label>KM Driven</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-shield-alt input-icon"></i>
                        <select name="ins_avail" onchange="toggleVehicleInsurance(this)" required>
                            <option value="" disabled selected></option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                        <label>Insurance Available</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-file-contract input-icon"></i>
                        <input type="text" name="ins_num" placeholder=" ">
                        <label>Policy/Card No</label>
                    </div>
                    <div class="input-group">
                        <i class="fas fa-calendar-alt input-icon"></i>
                        <input type="date" name="ins_expiry" placeholder=" ">
                        <label>Expired Date</label>
                    </div>
                </div>
            `;
            container.appendChild(section);
        }

        addBtn.addEventListener('click', createVehicleSection);
        addHealthBtn.addEventListener('click', createHealthInsSection);
        addLifeBtn.addEventListener('click', createLifeInsSection);

        // Init
        try {
            createVehicleSection();
            createHealthInsSection();
            createLifeInsSection();
        } catch (initErr) {
            console.error("Initialization error:", initErr);
            alert("Error initializing form sections: " + initErr.message);
        }

        // Submission
        form.onsubmit = async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');

            if (!currentUser) {
                alert("Please wait for the database to connect...");
                return;
            }

            console.log("Starting form submission...");
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';

            const formData = new FormData(form);

            const employeeData = {
                branch: formData.get('branch'),
                fullName: formData.get('fullName'),
                mobile: formData.get('mobile'),
                department: formData.get('department'),
                designation: formData.get('designation'),
                healthIns: [],
                lifeIns: [],
                vehicles: [],
                createdAt: serverTimestamp(),
                userId: currentUser.uid
            };

            // Collect Health Insurance Data
            const healthCards = document.querySelectorAll('.health-ins-card');
            healthCards.forEach(card => {
                const relationship = card.querySelector('[name="relationship"]').value;
                let beneficiary = card.querySelector('[name="referralDetail"]').value;
                let beneficiaryMobile = card.querySelector('[name="referralMobile"]').value;
                if (relationship === 'Self') {
                    beneficiary = '';
                    beneficiaryMobile = '';
                }

                const available = card.querySelector('[name="healthInsAvail"]').value;
                let provider = card.querySelector('[name="healthInsProvider"]').value;
                const other = card.querySelector('[name="healthInsOther"]').value;
                const id = card.querySelector('[name="healthInsID"]').value;
                const expiry = card.querySelector('[name="healthInsExpiry"]').value;

                if (provider === 'Other') provider = other;

                employeeData.healthIns.push({
                    relationship, beneficiary, beneficiaryMobile, available, provider, id, expiry
                });
            });

            // Collect Life Insurance Data
            const lifeCards = document.querySelectorAll('.life-ins-card');
            lifeCards.forEach(card => {
                const relationship = card.querySelector('[name="relationship"]').value;
                let beneficiary = card.querySelector('[name="referralDetail"]').value;
                let beneficiaryMobile = card.querySelector('[name="referralMobile"]').value;
                if (relationship === 'Self') {
                    beneficiary = '';
                    beneficiaryMobile = '';
                }

                const available = card.querySelector('[name="lifeInsAvail"]').value;
                let provider = card.querySelector('[name="lifeInsProvider"]').value;
                const other = card.querySelector('[name="lifeInsOther"]').value;
                const id = card.querySelector('[name="lifeInsID"]').value;
                const expiry = card.querySelector('[name="lifeInsExpiry"]').value;

                if (provider === 'Other') provider = other;

                employeeData.lifeIns.push({
                    relationship, beneficiary, beneficiaryMobile, available, provider, id, expiry
                });
            });

            // Collect Vehicle Data
            const vehicleCards = document.querySelectorAll('.vehicle-card');
            vehicleCards.forEach(card => {
                const v = {};
                card.querySelectorAll('[name]').forEach(input => {
                    v[input.name] = input.value;
                });

                // Handle Relationship for Vehicle specifically if names match
                // Note: The template adds 'relationship' and 'referralDetail' names
                // 'v' already collects them by loop, but we might want to clean 'referralDetail' if Self
                if (v['relationship'] === 'Self') {
                    v['referralDetail'] = '';
                    v['referralMobile'] = '';
                }

                employeeData.vehicles.push(v);
            });

            try {
                console.log("Data collected, attempting to save...", employeeData);

                if (currentEditingId) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'submissions', currentEditingId), employeeData);
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), employeeData);
                }

                statusMsg.style.display = 'block';
                statusMsg.className = 'status-msg';
                statusMsg.innerHTML = currentEditingId ? '<strong>Updated!</strong> Your details have been successfully updated.' : '<strong>Success!</strong> Your details have been recorded.';

                window.scrollTo({ top: 0, behavior: 'smooth' });
                form.reset();
                container.innerHTML = '';
                healthContainer.innerHTML = '';
                lifeContainer.innerHTML = '';
                vehicleCount = 0;
                healthInsCount = 0;
                lifeInsCount = 0;
                currentEditingId = null;
                submitBtn.innerHTML = 'Submit Registration';

                createVehicleSection();
                createHealthInsSection();
                createLifeInsSection();
            } catch (err) {
                console.error("Submission error:", err);
                alert("Submission failed: " + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = currentEditingId ? '<i class="fas fa-save mr-2"></i> Update My Details' : 'Submit Registration';
                setTimeout(() => statusMsg.style.display = 'none', 5000);
            }
        };

        // Data Management
        function listenToSubmissions() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
            const listContainer = document.getElementById('submissionsList');
            const emptyMsg = document.getElementById('emptyTableMsg');

            onSnapshot(q, (snapshot) => {
                allSubmissions = [];
                listContainer.innerHTML = '';
                listContainer.appendChild(emptyMsg);

                if (snapshot.empty) {
                    emptyMsg.style.display = 'block';
                    emptyMsg.innerText = "No records found.";
                    return;
                }

                emptyMsg.style.display = 'none';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allSubmissions.push(data);

                    const dateStr = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'Saving...';

                    // Health Summary
                    const healthSummary = Array.isArray(data.healthIns) ? data.healthIns.map(h =>
                        `<div class="mb-1 last:mb-0">
                            <div class="text-xs font-semibold ${h.available === 'Yes' ? 'text-green-600' : 'text-gray-400'}">
                                ${h.available} 
                                ${h.relationship ? `<span class="text-gray-500 font-normal">(${h.relationship}${h.beneficiary ? `: ${h.beneficiary}` : ''}${h.beneficiaryMobile ? ` - ${h.beneficiaryMobile}` : ''})</span>` : ''}
                            </div>
                            ${h.available === 'Yes' ? `<div class="text-[10px] text-gray-500 truncate">${h.provider}</div>` : ''}
                        </div>`
                    ).join('') : '<div class="text-xs text-gray-400">N/A</div>';

                    // Life Summary
                    const lifeSummary = Array.isArray(data.lifeIns) ? data.lifeIns.map(l =>
                        `<div class="mb-1 last:mb-0">
                            <div class="text-xs font-semibold ${l.available === 'Yes' ? 'text-blue-600' : 'text-gray-400'}">
                                ${l.available}
                                ${l.relationship ? `<span class="text-gray-500 font-normal">(${l.relationship}${l.beneficiary ? `: ${l.beneficiary}` : ''}${l.beneficiaryMobile ? ` - ${l.beneficiaryMobile}` : ''})</span>` : ''}
                            </div>
                            ${l.available === 'Yes' ? `<div class="text-[10px] text-gray-500 truncate">${l.provider}</div>` : ''}
                        </div>`
                    ).join('') : '<div class="text-xs text-gray-400">N/A</div>';

                    // Vehicle summary
                    const vehicleSummary = data.vehicles.map((v, i) =>
                        `<div class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-car text-blue-500 mr-1"></i> <b>${v.brand}</b> ${v.model} (${v.type})
                            ${v.relationship ? `<span class="block text-[10px] text-gray-400 pl-4">- ${v.relationship}${v.referralDetail ? `: ${v.referralDetail}` : ''}${v.referralMobile ? ` - ${v.referralMobile}` : ''}</span>` : ''}
                         </div>`
                    ).join('');

                    const card = document.createElement('div');
                    card.className = 'admin-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-bold text-gray-800 text-lg">${data.fullName}</div>
                                <div class="text-xs text-gray-500">${data.designation} | ${data.branch}</div>
                            </div>
                            <div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${dateStr}</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-3">
                            <div class="bg-gray-50 p-2 rounded border border-gray-100">
                                <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Health Ins. (${Array.isArray(data.healthIns) ? data.healthIns.length : 0})</div>
                                ${healthSummary}
                            </div>
                            <div class="bg-gray-50 p-2 rounded border border-gray-100">
                                <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Life Ins. (${Array.isArray(data.lifeIns) ? data.lifeIns.length : 0})</div>
                                ${lifeSummary}
                            </div>
                        </div>

                        ${data.vehicles.length > 0 ? `
                        <div class="border-t border-gray-100 pt-2">
                             <div class="text-[10px] text-gray-400 uppercase font-bold mb-1">Vehicles (${data.vehicles.length})</div>
                             ${vehicleSummary}
                        </div>` : ''}
                        
                        <div class="mt-3 pt-2 border-t border-gray-100 flex justify-between items-center">
                            <div class="text-xs text-gray-400">
                                <i class="fas fa-phone mr-1"></i> ${data.mobile}
                            </div>
                             <div class="text-xs text-gray-400">
                                <i class="fas fa-building mr-1"></i> ${data.department}
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            });
        }

        // CSV Export
        downloadBtn.onclick = () => {
            if (allSubmissions.length === 0) return;

            let csv = "Full Name,Branch,Department,Designation,Mobile,Health Rel,Health Ben,Health Ben Mobile,Health Ins Avail,Health Provider,Health ID,Health Expiry,Life Rel,Life Ben,Life Ben Mobile,Life Ins Avail,Life Provider,Life ID,Life Expiry,Vehicle Rel,Vehicle Ben,Vehicle Ben Mobile,Vehicle Type,Brand,Model,Ownership,KM,Ins Avail,Ins No,Ins Expiry\n";

            allSubmissions.forEach(row => {
                // Flatten Health Arrays
                const hRel = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.relationship || '-').join(' | ') : (row.healthIns?.relationship || 'N/A');
                const hBen = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.beneficiary || '-').join(' | ') : (row.healthIns?.beneficiary || 'N/A');
                const hBenMob = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.beneficiaryMobile || '-').join(' | ') : (row.healthIns?.beneficiaryMobile || 'N/A');
                const hAvail = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.available).join(' | ') : (row.healthIns?.available || 'N/A');
                const hProv = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.provider).join(' | ') : (row.healthIns?.provider || 'N/A');
                const hId = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.id).join(' | ') : (row.healthIns?.id || 'N/A');
                const hExp = Array.isArray(row.healthIns) ? row.healthIns.map(h => h.expiry || 'N/A').join(' | ') : (row.healthIns?.expiry || 'N/A');

                // Flatten Life Arrays
                const lRel = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.relationship || '-').join(' | ') : (row.lifeIns?.relationship || 'N/A');
                const lBen = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.beneficiary || '-').join(' | ') : (row.lifeIns?.beneficiary || 'N/A');
                const lBenMob = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.beneficiaryMobile || '-').join(' | ') : (row.lifeIns?.beneficiaryMobile || 'N/A');
                const lAvail = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.available).join(' | ') : (row.lifeIns?.available || 'N/A');
                const lProv = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.provider).join(' | ') : (row.lifeIns?.provider || 'N/A');
                const lId = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.id).join(' | ') : (row.lifeIns?.id || 'N/A');
                const lExp = Array.isArray(row.lifeIns) ? row.lifeIns.map(l => l.expiry || 'N/A').join(' | ') : (row.lifeIns?.expiry || 'N/A');

                if (!row.vehicles || row.vehicles.length === 0) {
                    csv += `"${row.fullName}","${row.branch}","${row.department}","${row.designation}","${row.mobile}","${hRel}","${hBen}","${hBenMob}","${hAvail}","${hProv}","${hId}","${hExp}","${lRel}","${lBen}","${lBenMob}","${lAvail}","${lProv}","${lId}","${lExp}","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A","N/A"\n`;
                } else {
                    row.vehicles.forEach(v => {
                        csv += `"${row.fullName}","${row.branch}","${row.department}","${row.designation}","${row.mobile}","${hRel}","${hBen}","${hBenMob}","${hAvail}","${hProv}","${hId}","${hExp}","${lRel}","${lBen}","${lBenMob}","${lAvail}","${lProv}","${lId}","${lExp}","${v.relationship || '-'}","${v.referralDetail || '-'}","${v.referralMobile || '-'}","${v.type}","${v.brand}","${v.model}","${v.ownership}","${v.km}","${v.ins_avail}","${v.ins_num}","${v.ins_expiry}"\n`;
                    });
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Employee_Data_Export.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>

</html>